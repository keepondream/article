<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" type="text/css" href="/statics/css/index.css">
</head>

<body>

	<h1 style="text-align: center;">DF5G免费文件转换</h1>


	<form id="projectForm">
		<label for="url">网址</label>
		<input type="text" name="url" id="url" placeholder="请输入网址">
		<br />
		<label for="file">文件</label>
		<input type="file" name="file" id="file">
		<br />
		<label for="ext">转换类型</label>
		<select name="ext" id="ext">
			<option value="">--请选择--</option>
			<option value="pdf">PDF</option>
			<option value="jpg">JPG</option>
			<option value="jpeg">JPEG</option>
			<option value="png">PNG</option>
			<option value="doc">DOC</option>
			<option value="docx">DOCX</option>
			<option value="html">HTML</option>
		</select>
		<br />
		<button type="button" class="btn_submit" id="submit">提交</button>
	</form>

	<div id="notice" class="hide">
		<div id="notice_title">错误提示:</div>
		<div id="notice_text">
			sssssssss
		</div>
	</div>
</body>

</html>
<script src="/statics/js/jquery-3.5.0.js"></script>
<script>
	//在此书写你的jquery代码
	$(function () {
		let notice = $("#notice")
		let notice_text = $("#notice_text")
		let notice_title = $("#notice_title")
		let submit = $("#submit")


		$("#submit").on('click', function () {
			disableBtn()
			let that = $(this)
			let url = $("#url").val()
			let file = $("#file").get(0).files[0]
			if (!url && !file) {
				alert("网址或者文件必填")
				enableBtn()
				return
			}
			let ext = $("#ext").val()
			if (!ext) {
				alert("转换类型必填")
				enableBtn()
				return
			}


			let fullFileName = $("#file").val()
			if (fullFileName) {
				let oldExt = fullFileName.split('.').pop().toLowerCase();
				if (oldExt == ext) {
					alert("同类型文件无需转换,请更换类型")
					enableBtn()
					return
				}
				console.log("oldExt", oldExt)
			}

			let data = new FormData($("#projectForm")[0])
			$.ajax({
				type: "POST",
				dataType: 'json',
				processData: false,// jQuery不处理数据
				contentType: false,// jQuery不设置contentType
				data: data,
				url: '/api/upload',
				success: function (json, textStatus, xhr) {
					enableBtn()
					if (json.code == 400) {
						showNotice("温馨提示:", json.msg)
						return
					} else {
						if (!json.data.filefullname || !json.data.filename) {
							showNotice("温馨提示:", "文件转换失败,请稍后再试")
							return
						}
						let html = `<a href="/api/download/${json.data.filefullname}" target="view_window">${json.data.filename}</a>`
						console.log(html)
						showNotice("转换成功:", '', html)
					}
					console.log("success", json, textStatus, xhr)
				},
				error: function (xhr, textStatus, errorThrown) {
					enableBtn()
					alert("转换失败,请稍后再试")
					console.log("error", xhr, textStatus, errorThrown)
				}
			})
		})

		$("#url").change(function () {
			hideNotice()
			$("#file").val("")
		})

		$("#file").change(function () {
			hideNotice()
			$("#url").val("")
		})

		$("#ext").change(function () {
			hideNotice()
		})

		// 隐藏提示框
		hideNotice = function () {
			notice_title.text('')
			notice_text.text('')
			notice.hide()
			enableBtn()
		}

		// 显示提示框,并设值
		showNotice = function (title, text, html) {
			notice_title.text(title)
			if (html) {
				notice_text.html(html)
			} else {
				notice_text.text(text)
			}
			notice.show()
		}

		disableBtn = function () {
			submit.attr('disabled', true)
		}

		enableBtn = function () {
			submit.attr('disabled', false)
		}

		hideNotice()


	});


</script>